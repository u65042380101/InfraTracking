{% extends "base.html" %}
{% block title %}Helpdesk Dashboard{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

  <!-- แสดงชื่อสาขาและเลขสาขา -->
  <div class="mb-6 text-center">
    <h2 class="text-2xl font-bold text-gray-800">
      สาขา/หน่วย : {{ branch_name }} | เลขสาขา : {{ branch_code }}
    </h2>
  </div>

  <form method="get" class="mb-6 flex justify-end" >
    <a href="{% url 'add_record' %}?branch_code={{ branch_code }}"
   class="inline-flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg shadow transition duration-200 mr-2">
  + เพิ่มข้อมูล
</a>
    <input
      type="text"
      id="search-input"
      name="q"
      value="{{ request.GET.q }}"
      placeholder="ค้นหาด้วยชื่อสาขา, อุปกรณ์, ปัญหา ฯลฯ"
      class="border border-gray-300 rounded px-3 py-2 w-64 mr-2"
    />
    <button
      type="submit"
      class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
    >
      ค้นหา
    </button>
  </form>

  {% if success_message %}
  <div id="success-alert" class="mb-6">
    <div class="bg-green-100 border border-green-300 text-green-700 px-6 py-4 rounded-lg shadow">
      <div class="font-semibold">{{ success_message }}</div>
      {% if last_record %}
        <div class="mt-2 text-sm text-gray-800">
          <span class="font-semibold">ข้อมูลล่าสุด:</span>
          หมายเลข <strong>{{ last_record.number }}</strong>, สาขา
          <strong>{{ last_record.branch_name }}</strong>, สถานะ :
          {% if last_record.status == "แก้ไขแล้ว" %}
            <span class="inline-block px-2 py-1 rounded bg-green-100 text-green-700 font-semibold">
              {{ last_record.status }}
            </span>
          {% elif last_record.status == "กำลังรอดำเนินการ" %}
            <span class="inline-block px-2 py-1 rounded bg-orange-100 text-orange-700 font-semibold">
              {{ last_record.status }}
            </span>
          {% else %}
            <span class="inline-block px-2 py-1 rounded bg-gray-100 text-gray-700 font-semibold">
              {{ last_record.status }}
            </span>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
  <script>
    setTimeout(function () {
      var alert = document.getElementById("success-alert");
      if (alert) {
        alert.style.display = "none";
      }
    }, 20000);
  </script>
  {% endif %}

  {% if messages %}
  <div class="mb-6 space-y-2">
    {% for message in messages %}
      <div class="bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded shadow">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="overflow-x-auto bg-white rounded-lg shadow ring-1 ring-black ring-opacity-5">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-100 text-gray-700 uppercase tracking-wider text-xs font-medium">
        <tr>
          <th class="px-4 py-3 text-left">สาขา</th>
<th class="px-4 py-3 text-left">อุปกรณ์</th>
<th class="px-4 py-3 text-left">ผู้ให้บริการ</th>
<th class="px-4 py-3 text-left">ปัญหา</th>
<th class="px-4 py-3 text-left">วิธีแก้ไข</th>
<th class="px-4 py-3 text-left">วันที่</th>
<th class="px-4 py-3 text-left">โดย</th>
<th class="px-4 py-3 text-left">สถานะ</th>
<th class="px-4 py-3 text-left">การจัดการ</th>
</tr>
      </thead>
      <tbody class="divide-y divide-gray-100 bg-white">
        {% for record in records %}
        <tr class="hover:bg-gray-50 transition duration-200">
          
          <td class="px-4 py-2">{{ record.branch_name }}</td>
          <td class="px-4 py-2">{{ record.device }}</td>
          <td class="px-4 py-2">{{ record.provider }}</td>
          <td class="px-4 py-2 text-gray-700">{{ record.problem }}</td>
          <td class="px-4 py-2 text-gray-700">{{ record.solution }}</td>
          <td class="px-4 py-2">{{ record.date|date:"d/m/Y" }}</td>
          <td class="px-4 py-2">{{ record.by }}</td>
          <td class="px-4 py-2">
            {% if record.get_status_display == "แก้ไขแล้ว" %}
              <span class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">
                {{ record.get_status_display }}
              </span>
            {% else %}
              <span class="inline-block px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">
                {{ record.get_status_display }}
              </span>
            {% endif %}
          </td>
          <td class="px-4 py-2">
            <div class="flex space-x-2">
              <a href="{% url 'edit_record' record.pk %}" class="inline-block bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded">แก้ไข</a>
              <form method="POST" action="{% url 'delete_record' record.pk %}" onsubmit="return confirm('คุณแน่ใจหรือไม่ที่จะลบรายการนี้?');">
                {% csrf_token %}
                {% comment %} <button type="submit" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded">ลบ</button> {% endcomment %}
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="11" class="text-center text-gray-500 py-6">
            ไม่มีข้อมูลในระบบ
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("search-input");
  const table = document.querySelector("table");
  const rows = table.querySelectorAll("tbody tr");

  input.addEventListener("input", function () {
    const keyword = this.value.trim().toLowerCase();
    let hasResult = false;
    rows.forEach(row => {
      // ข้ามแถว "ไม่มีข้อมูลในระบบ"
      if (row.querySelectorAll("td").length === 1) return;
      const text = row.textContent.toLowerCase();
      if (text.includes(keyword)) {
        row.style.display = "";
        hasResult = true;
      } else {
        row.style.display = "none";
      }
    });
    // แสดง/ซ่อนแถว "ไม่มีข้อมูลในระบบ"
    const emptyRow = table.querySelector("tbody tr td[colspan]");
    if (emptyRow) {
      emptyRow.parentElement.style.display = hasResult ? "none" : "";
    }
  });
});
</script>
{% endblock %}