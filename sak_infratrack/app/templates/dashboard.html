{% extends "base.html" %}

{% block title %}infratrackInfo Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-blue-700 mb-4 sm:mb-0 text-center sm:text-left">üìä infratrackInfo Dashboard</h1>
    <a href="{% url 'summary_report' %}" target="_blank"
       class="bg-white border border-gray-300 px-4 py-2 rounded-xl shadow text-gray-700 hover:bg-gray-100 transition">
      ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Export PDF
    </a>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-10">
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition-transform transform hover:-translate-y-1">
      <span class="text-4xl font-extrabold text-blue-600">{{ today_count }}</span>
      <span class="mt-2 text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition-transform transform hover:-translate-y-1">
      <span class="text-4xl font-extrabold text-green-600">{{ month_count }}</span>
      <span class="mt-2 text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition-transform transform hover:-translate-y-1">
      <span class="text-4xl font-extrabold text-orange-600">{{ year_count }}</span>
      <span class="mt-2 text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
    </div>
  </div>

  <!-- Search Input -->
  <div class="mb-8 flex justify-center">
    <input
      type="text"
      id="searchInput"
      placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤..."
      class="w-full sm:w-96 px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
    />
  </div>

  <!-- Branch Cards -->
  <div id="branchGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for branch in branch_list %}
    <div
      class="branch-card cursor-pointer flex flex-col gap-4 bg-white p-5 rounded-2xl shadow-md hover:shadow-xl hover:-translate-y-1 transform transition"
      data-branch-code="{{ branch.branch_code|lower }}"
      data-branch-name="{{ branch.branch_name|lower }}"
      style="display:none"
      onclick="showInternetLinks('{{ branch.branch_code }}','{{ branch.branch_name|escapejs }}')"
      role="button"
      tabindex="0"
      onkeydown="if(event.key==='Enter' || event.key===' '){showInternetLinks('{{ branch.branch_code }}','{{ branch.branch_name|escapejs }}');}"
    >
      <!-- Header -->
      <div class="text-lg font-bold text-blue-700 border-b pb-2">{{ branch.branch_name }}</div>

      <!-- Info -->
      <div class="text-sm text-gray-600 space-y-1 flex-1">
        <p><span class="font-semibold">üè† Address:</span> {{ branch.address }}</p>
        <p><span class="font-semibold">üìç District:</span> {{ branch.district }}</p>
        <p><span class="font-semibold">üó∫Ô∏è Region:</span> {{ branch.region }}</p>
        <p><span class="font-semibold">üè¢ Province:</span> {{ branch.province }}</p>
        <p><span class="font-semibold">üì± Mobile:</span> {{ branch.mobile_number }}</p>
        <p><span class="font-semibold">‚òéÔ∏è Tel 6 Digits:</span> {{ branch.tel_6_digits }}</p>
      </div>

      <!-- Button -->
      <a
        href="{% url 'helpdesk_record' branch.branch_code %}"
        class="bg-blue-600 text-white py-2 rounded-xl shadow text-center font-medium hover:bg-blue-700 transition"
        onclick="event.stopPropagation();"
      >
        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      </a>
    </div>
    {% empty %}
    <p class="col-span-full text-center text-gray-500 py-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</p>
    {% endfor %}
  </div>
  <div id="pagination" class="flex justify-center mt-8 gap-2"></div>
</div>

<!-- Modal -->
<div id="internetLinkModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
     onclick="if(event.target === this) closeModal();">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 relative">
    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    <h3 id="modalBranchName" class="text-2xl font-bold mb-6 text-blue-700"></h3>
    <div id="modalContent" class="overflow-x-auto max-h-96"></div>
  </div>
</div>

<script>
function showInternetLinks(branchCode, branchName) {
  const modal = document.getElementById('internetLinkModal');
  const modalContent = document.getElementById('modalContent');
  const modalBranchName = document.getElementById('modalBranchName');

  modalBranchName.textContent = `InternetLink ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName} (${branchCode})`;
  modal.classList.remove('hidden');
  modalContent.innerHTML = '<p class="text-gray-500 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

  fetch(`/api/internet-links/${branchCode}/`)
    .then(r => r.json())
    .then(data => {
      if (!data || data.length === 0) {
        modalContent.innerHTML = '<p class="text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• InternetLink</p>';
        return;
      }
      let table = `<table class="min-w-full text-sm text-left border border-gray-300 rounded-lg overflow-hidden">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="border px-3 py-2">Provider</th>
            <th class="border px-3 py-2">FTTx</th>
            <th class="border px-3 py-2">Speed</th>
            <th class="border px-3 py-2">Start Date</th>
            <th class="border px-3 py-2">Last Service</th>
            <th class="border px-3 py-2">Service Center</th>
          </tr>
        </thead>
        <tbody>`;
      data.forEach(link => {
        table += `<tr class="hover:bg-gray-50">
          <td class="border px-3 py-2">${link.proivider ?? ''}</td>
          <td class="border px-3 py-2">${link.fttx ?? ''}</td>
          <td class="border px-3 py-2">${link.speed ?? ''}</td>
          <td class="border px-3 py-2">${link.start_date ?? ''}</td>
          <td class="border px-3 py-2">${link.last_service ?? ''}</td>
          <td class="border px-3 py-2">${link.service_center ?? ''}</td>
        </tr>`;
      });
      table += '</tbody></table>';
      modalContent.innerHTML = table;
    })
    .catch(() => {
      modalContent.innerHTML = '<p class="text-red-500 py-4">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    });
}

function closeModal() {
  document.getElementById('internetLinkModal').classList.add('hidden');
}

const cardsPerPage = 6; // 2 ‡πÅ‡∏ñ‡∏ß (‡∏ñ‡πâ‡∏≤ 3 columns)
let currentPage = 1;

function showPage(page) {
  const cards = document.querySelectorAll('.branch-card');
  const totalPages = Math.ceil(cards.length / cardsPerPage);
  currentPage = Math.max(1, Math.min(page, totalPages));

  cards.forEach((card, i) => {
    card.style.display = (i >= (currentPage-1)*cardsPerPage && i < currentPage*cardsPerPage) ? '' : 'none';
  });

  // Render pagination
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = 'px-3 py-1 rounded ' + (i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100');
    btn.onclick = () => showPage(i);
    pagination.appendChild(btn);
  }
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î
showPage(1);

// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö paginate
document.getElementById('searchInput').addEventListener('input', function () {
  const keyword = this.value.trim().toLowerCase();
  const cards = document.querySelectorAll('.branch-card');
  let found = false;
  let visibleCards = [];
  cards.forEach(card => {
    const code = card.getAttribute('data-branch-code');
    const name = card.getAttribute('data-branch-name');
    if (code.includes(keyword) || name.includes(keyword)) {
      card.style.display = '';
      visibleCards.push(card);
      found = true;
    } else {
      card.style.display = 'none';
    }
  });

  let emptyMsg = document.getElementById('emptyMsg');
  if (!found) {
    if (!emptyMsg) {
      emptyMsg = document.createElement('p');
      emptyMsg.id = 'emptyMsg';
      emptyMsg.className = 'col-span-full text-center text-gray-500 py-6';
      emptyMsg.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
      document.getElementById('branchGrid').appendChild(emptyMsg);
    }
    document.getElementById('pagination').innerHTML = '';
  } else {
    if (emptyMsg) emptyMsg.remove();
    // paginate ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    visibleCards.forEach(card => card.style.display = 'none');
    let page = 1;
    const totalPages = Math.ceil(visibleCards.length / cardsPerPage);
    function showSearchPage(p) {
      page = Math.max(1, Math.min(p, totalPages));
      visibleCards.forEach((card, i) => {
        card.style.display = (i >= (page-1)*cardsPerPage && i < page*cardsPerPage) ? '' : 'none';
      });
      // Render pagination
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'px-3 py-1 rounded ' + (i === page ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100');
        btn.onclick = () => showSearchPage(i);
        pagination.appendChild(btn);
      }
    }
    showSearchPage(1);
  }
});
</script>
{% endblock %}
