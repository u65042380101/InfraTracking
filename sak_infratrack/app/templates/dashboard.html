{% extends "base.html" %}

{% block title %}infratrackInfo Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-blue-700 mb-4 sm:mb-0 text-center sm:text-left">üìä infratrackInfo Dashboard</h1>
    <a href="{% url 'summary_report' %}" target="_blank"
       class="bg-white border border-gray-300 px-4 py-2 rounded-xl shadow text-gray-700 hover:bg-gray-100 transition">
      ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Export PDF
    </a>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-10">
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition-transform transform hover:-translate-y-1">
      <span class="text-4xl font-extrabold text-blue-600">{{ today_count }}</span>
      <span class="mt-2 text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition-transform transform hover:-translate-y-1">
      <span class="text-4xl font-extrabold text-green-600">{{ month_count }}</span>
      <span class="mt-2 text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
    </div>
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition-transform transform hover:-translate-y-1">
      <span class="text-4xl font-extrabold text-orange-600">{{ year_count }}</span>
      <span class="mt-2 text-gray-700 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
    </div>
  </div>

  <!-- Search Input -->
  <div class="mb-8 flex justify-center">
    <input
      type="text"
      id="searchInput"
      placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤..."
      class="w-full sm:w-96 px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-500"
    />
  </div>

  <!-- Branch Cards -->
  <div id="branchGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for branch in branch_list %}
    <div
      class="branch-card cursor-pointer flex flex-col gap-4 bg-white p-5 rounded-2xl shadow-md hover:shadow-xl hover:-translate-y-1 transform transition relative"
      data-branch-code="{{ branch.branch_code|lower }}"
      data-branch-name="{{ branch.branch_name|lower }}"
      style="display:none"
      onclick="showInternetLinks('{{ branch.branch_code }}','{{ branch.branch_name|escapejs }}')"
      role="button"
      tabindex="0"
      onkeydown="if(event.key==='Enter' || event.key===' '){showInternetLinks('{{ branch.branch_code }}','{{ branch.branch_name|escapejs }}');}"
    >
      {% if branch.done_count > 0 %}
        <span class="absolute top-3 right-16 bg-green-600 text-white text-xs font-bold rounded-full px-2 py-0.5 shadow">
          {{ branch.done_count }}
        </span>
      {% endif %}
      {% if branch.alert_count > 0 %}
        <span class="absolute top-3 right-4 bg-red-600 text-white text-xs font-bold rounded-full px-2 py-0.5 shadow">
          {{ branch.alert_count }}
        </span>
      {% endif %}
      <!-- Header -->
      <div class="text-lg font-bold text-blue-700 border-b pb-2">{{ branch.branch_name }}</div>

      <!-- Info -->
      <div class="text-sm text-gray-600 space-y-1 flex-1">
        <p><span class="font-semibold">üè† Address:</span> {{ branch.address }}</p>
        <p><span class="font-semibold">üìç District:</span> {{ branch.district }}</p>
        <p><span class="font-semibold">üó∫Ô∏è Region:</span> {{ branch.region }}</p>
        <p><span class="font-semibold">üè¢ Province:</span> {{ branch.province }}</p>
        <p><span class="font-semibold">üì± Mobile:</span> {{ branch.mobile_number }}</p>
        <p><span class="font-semibold">‚òéÔ∏è Tel 6 Digits:</span> {{ branch.tel_6_digits }}</p>
      </div>

      <!-- Button -->
      <a
        href="{% url 'helpdesk_record' branch.branch_code %}"
        class="bg-blue-600 text-white py-2 rounded-xl shadow text-center font-medium hover:bg-blue-700 transition"
        onclick="event.stopPropagation();"
      >
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡πÄ‡∏Å‡πâ‡πÑ‡∏Ç
      </a>
    </div>
    {% empty %}
    <p class="col-span-full text-center text-gray-500 py-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</p>
    {% endfor %}
  </div>
  <div id="pagination" class="flex justify-center mt-8 gap-2"></div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
  <div class="mb-10">
    <h2 class="text-xl font-bold text-blue-700 mb-4">üïí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 rounded-xl bg-white shadow">
        <thead class="bg-blue-100">
          <tr>
            <th class="px-3 py-2 border">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="px-3 py-2 border">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤</th>
            <th class="px-3 py-2 border">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</th>
            <th class="px-3 py-2 border">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
            <th class="px-3 py-2 border">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
            <th class="px-3 py-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="px-3 py-2 border">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
          </tr>
        </thead>
        <tbody>
          {% for r in latest_records %}
          <tr class="hover:bg-blue-50 cursor-pointer"
              onclick="window.location.href='{% url 'helpdesk_record' r.branch_code %}'">
            <td class="px-3 py-2 border">{{ r.date }}</td>
            <td class="px-3 py-2 border">{{ r.branch_code }}</td>
            <td class="px-3 py-2 border">{{ r.branch_name }}</td>
            <td class="px-3 py-2 border">{{ r.device }}</td>
            <td class="px-3 py-2 border">{{ r.problem }}</td>
            <td class="px-3 py-2 border">
              {% if r.status == 1 %}
                <span class="inline-block px-3 py-1 rounded-full text-green-800 bg-green-100 font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</span>
              {% elif r.status == 2 %}
                <span class="inline-block px-3 py-1 rounded-full text-orange-800 bg-orange-100 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
              {% elif r.status == 3 %}
                <span class="inline-block px-3 py-1 rounded-full text-orange-800 bg-orange-100 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-3 py-2 border">{{ r.by }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-gray-500 py-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="internetLinkModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
     onclick="if(event.target === this) closeModal();">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 relative">
    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    <h3 id="modalBranchName" class="text-2xl font-bold mb-6 text-blue-700"></h3>
    <div id="modalContent" class="overflow-x-auto max-h-96"></div>
  </div>
</div>

<script>
/* ===== Modal (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ===== */
function showInternetLinks(branchCode, branchName) {
  const modal = document.getElementById('internetLinkModal');
  const modalContent = document.getElementById('modalContent');
  const modalBranchName = document.getElementById('modalBranchName');

  modalBranchName.textContent = `InternetLink ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName} (${branchCode})`;
  modal.classList.remove('hidden');
  modalContent.innerHTML = '<p class="text-gray-500 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

  fetch(`/api/internet-links/${branchCode}/`)
    .then(r => r.json())
    .then(data => {
      if (!data || data.length === 0) {
        modalContent.innerHTML = '<p class="text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• InternetLink</p>';
        return;
      }
      let table = `<table class="min-w-full text-sm text-left border border-gray-300 rounded-lg overflow-hidden">
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="border px-3 py-2">Provider</th>
            <th class="border px-3 py-2">FTTx</th>
            <th class="border px-3 py-2">Speed</th>
            <th class="border px-3 py-2">Start Date</th>
            <th class="border px-3 py-2">Last Service</th>
            <th class="border px-3 py-2">Service Center</th>
          </tr>
        </thead>
        <tbody>`;
      data.forEach(link => {
        table += `<tr class="hover:bg-gray-50">
          <td class="border px-3 py-2">${link.proivider ?? ''}</td>
          <td class="border px-3 py-2">${link.fttx ?? ''}</td>
          <td class="border px-3 py-2">${link.speed ?? ''}</td>
          <td class="border px-3 py-2">${link.start_date ?? ''}</td>
          <td class="border px-3 py-2">${link.last_service ?? ''}</td>
          <td class="border px-3 py-2">${link.service_center ?? ''}</td>
        </tr>`;
      });
      table += '</tbody></table>';
      modalContent.innerHTML = table;
    })
    .catch(() => {
      modalContent.innerHTML = '<p class="text-red-500 py-4">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    });
}
function closeModal() {
  document.getElementById('internetLinkModal').classList.add('hidden');
}

/* ===== Pagination (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ) ===== */
const cardsPerPage = 6; // 2 ‡πÅ‡∏ñ‡∏ß (‡∏ñ‡πâ‡∏≤ 3 columns)
let currentPage = 1;
let filteredCards = null;   // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î/‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)

const paginationEl = document.getElementById('pagination');
const gridEl = document.getElementById('branchGrid');
const allCards = Array.from(document.querySelectorAll('.branch-card'));

function renderCards(page, cards) {
  const totalPages = Math.max(1, Math.ceil(cards.length / cardsPerPage));
  currentPage = Math.min(Math.max(1, page), totalPages);

  // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  cards.forEach((card, i) => {
    const idx = i + 1;
    const start = (currentPage - 1) * cardsPerPage + 1;
    const end   = currentPage * cardsPerPage;
    card.style.display = (idx >= start && idx <= end) ? '' : 'none';
  });

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô filteredCards)
  const others = allCards.filter(c => !cards.includes(c));
  others.forEach(c => c.style.display = 'none');

  renderPagination(totalPages, (p) => renderCards(p, cards));
}

function renderPagination(totalPages, onGoto) {
  paginationEl.innerHTML = '';

  const maxButtons = 7; // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
  const makeBtn = (label, page, opts={}) => {
    const { disabled=false, active=false } = opts;
    const b = document.createElement('button');
    b.textContent = label;
    b.className = 'px-3 py-1 rounded mx-1 ' +
      (active ? 'bg-blue-600 text-white'
              : disabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                         : 'bg-gray-200 text-gray-700 hover:bg-blue-100');
    b.disabled = disabled;
    if (!disabled && !active) b.onclick = () => onGoto(page);
    return b;
  };
  const dots = () => {
    const s = document.createElement('span');
    s.textContent = '‚Ä¶';
    s.className = 'px-2 text-gray-500';
    return s;
  };

  // Prev
  paginationEl.appendChild(makeBtn('Prev', currentPage - 1, { disabled: currentPage === 1 }));

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ (window)
  let start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
  let end = start + maxButtons - 1;
  if (end > totalPages) {
    end = totalPages;
    start = Math.max(1, end - maxButtons + 1);
  }

  // First + dots
  if (start > 1) {
    paginationEl.appendChild(makeBtn('1', 1));
    if (start > 2) paginationEl.appendChild(dots());
  }

  for (let i = start; i <= end; i++) {
    paginationEl.appendChild(makeBtn(String(i), i, { active: i === currentPage }));
  }

  // dots + Last
  if (end < totalPages) {
    if (end < totalPages - 1) paginationEl.appendChild(dots());
    paginationEl.appendChild(makeBtn(String(totalPages), totalPages));
  }

  // Next
  paginationEl.appendChild(makeBtn('Next', currentPage + 1, { disabled: currentPage === totalPages }));
}

/* ===== ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏Ñ‡∏á UI ‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ pagination ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ===== */
document.getElementById('searchInput').addEventListener('input', function () {
  const keyword = this.value.trim().toLowerCase();

  // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  let emptyMsg = document.getElementById('emptyMsg');
  if (emptyMsg) emptyMsg.remove();

  if (keyword === '') {
    filteredCards = allCards;
  } else {
    filteredCards = allCards.filter(card => {
      const code = card.getAttribute('data-branch-code') || '';
      const name = card.getAttribute('data-branch-name') || '';
      return code.includes(keyword) || name.includes(keyword);
    });
  }

  if (filteredCards.length === 0) {
    allCards.forEach(c => c.style.display = 'none');
    paginationEl.innerHTML = '';
    emptyMsg = document.createElement('p');
    emptyMsg.id = 'emptyMsg';
    emptyMsg.className = 'col-span-full text-center text-gray-500 py-6';
    emptyMsg.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
    gridEl.appendChild(emptyMsg);
    return;
  }

  renderCards(1, filteredCards);
});

/* ===== ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î ===== */
filteredCards = allCards;
renderCards(1, filteredCards);
</script>
{% endblock %}